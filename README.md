
# VK Commentator README

## Описание
`vk-commentator.py` — это Python-скрипт для автоматического комментирования постов во ВКонтакте (VK) с использованием VK API и модели OpenAI GPT. Скрипт фильтрует посты по заданным критериям (лайки, комментарии, просмотры, длина текста, возраст поста), проверяет контент на соответствие требованиям, генерирует остроумные комментарии и сохраняет результаты в Google Таблицу. Он устойчив к ошибкам благодаря механизму повторных попыток и экспоненциальной задержке.

## Возможности
- **Автоматическое комментирование**: Генерирует и публикует комментарии к постам VK с использованием модели GPT-4o-mini.
- **Фильтрация контента**: Отбирает посты по лайкам, комментариям, просмотрам, длине текста и возрасту.
- **Модерация контента**: Использует OpenAI для отклонения неподходящего контента (например, насилие, спам, незаконный контент).
- **Интеграция с Google Таблицами**: Сохраняет данные о комментариях и использовании токенов в Google Таблицу.
- **Обработка ошибок**: Реализована логика повторных попыток с экспоненциальной задержкой для ошибок VK и Google API.
- **Логирование**: Подробное логирование в файл `vk_commentator.log` для отладки и мониторинга.

## Требования
- **Python**: 3.8 или выше
- **Зависимости**:
  ```
  pip install vk_api openai google-api-python-client google-auth pandas
  ```
- **Токен VK API**: Получить через приложение или https://vk.com/dev
- **Ключ OpenAI API**: Получить на https://platform.openai.com
- **Учетные данные Google Service Account**: JSON-файл для доступа к Google Sheets API (см. настройку ниже)
- **ID Google Таблицы**: Google Таблица для хранения логов

## Установка
1. **Установите Python**: Убедитесь, что Python 3.8+ установлен.
2. **Скачайте скрипт**: Клонируйте или скачайте `vk-commentator.py`.
3. **Установите зависимости**:
   ```
   pip install vk_api openai google-api-python-client google-auth pandas
   ```
4. **Получите учетные данные**:
   - **Токен VK API**:
     - **Через Kate Mobile**:
       1. Перейдите по [ссылке Kate Mobile](https://id.vk.com/auth?return_auth_hash=feae1c18342d33bb92&redirect_uri=https%3A%2F%2Foauth.vk.com%2Fblank.html&redirect_uri_hash=fc0d048a6a5bdf295f&force_hash=1&app_id=2685278&response_type=token&code_challenge=&code_challenge_method=&scope=1040183263&state=) **через браузер** (не используйте мобильное приложение).
       2. Авторизуйтесь в VK.
       3. После переадресации вы увидите URL вида: `https://oauth.vk.com/blank.html#access_token=vk1.a.ваш_токен&expires_in=86400&user_id=123456`.
       4. Скопируйте значение `access_token` (например, `vk1.a.GEX8jo_VOB...`). Это ваш токен.
     - **Альтернатива**: Создайте standalone-приложение на https://vk.com/dev, получите токен с правами `wall` и `newsfeed`.
   - **Ключ OpenAI API**:
     - Зарегистрируйтесь на https://platform.openai.com и сгенерируйте API-ключ.
   - **Учетные данные Google Service Account**:
     1. Перейдите в Google Cloud Console (https://console.cloud.google.com).
     2. Создайте проект или выберите существующий.
     3. Включите API Google Sheets (раздел "APIs & Services" → "Enable APIs and Services").
     4. Создайте учетные данные типа "Service Account" (раздел "Credentials" → "Create Credentials").
     5. Скачайте JSON-файл с учетными данными и переименуйте его в `credentials.json`.
     6. Откройте `credentials.json`, найдите поле `client_email` (например, `your-service-account@project-id.iam.gserviceaccount.com`).
     7. Откройте Google Таблицу, в которую будет записываться лог, и добавьте email из `client_email` в список администраторов (Share → Add email → Editor).
   - **ID Google Таблицы**:
     - Создайте Google Таблицу.
     - Скопируйте ID из URL (например, в `https://docs.google.com/spreadsheets/d/1Br3i3kaNxZaAWS8V8qgu16pSQL6--ubtwDpePwAFw1s` ID — это `1Br3i3kaNxZaAWS8V8qgu16pSQL6--ubtwDpePwAFw1s`).

## Настройка
Отредактируйте следующие переменные в начале `vk-commentator.py`:
```
VK_API_TOKEN = 'your_vk_api_token'  # Ваш токен VK API
OPENAI_API_KEY = 'your_openai_api_key'  # Ваш ключ OpenAI API
GOOGLE_SHEET_ID = 'your_google_sheet_id'  # ID вашей Google Таблицы
```
Поместите файл `credentials.json` в ту же папку, где находится `vk-commentator.py`.

### Дополнительные настройки
- **Тайминги**:
  - `COMMENT_PAUSE_MINUTES`: Задержка между комментариями (по умолчанию: 10 минут).
  - `SLEEP_AFTER_EMPTY_MINUTES`: Задержка при отсутствии подходящих постов (по умолчанию: 10 минут).
  - `API_DELAY`: Задержка между API-запросами для избежания лимитов (по умолчанию: 0.2 секунды).
- **Повторные попытки**:
  - `MAX_RETRIES`: Максимальное количество попыток для API-запросов (по умолчанию: 10).
  - `MAX_BACKOFF`: Максимальная задержка для повторных попыток (по умолчанию: 600 секунд).
- **Фильтры постов**:
  - `MIN_LIKES`: Минимальное количество лайков (по умолчанию: 0).
  - `MIN_COMMENTS`: Минимальное количество комментариев (по умолчанию: 0).
  - `MIN_VIEWS`: Минимальное количество просмотров (по умолчанию: 50).
  - `MAX_AGE_SECONDS`: Максимальный возраст поста в секундах (по умолчанию: 3600, т.е. 1 час).
  - `MIN_TEXT_LENGTH`: Минимальная длина текста поста (по умолчанию: 50 символов).
  - `MAX_TEXT_LENGTH`: Максимальная длина текста поста (по умолчанию: 500 символов).

## Использование
1. **Подготовьте окружение**:
   - Убедитесь, что `credentials.json` находится в папке со скриптом.
   - Обновите `VK_API_TOKEN`, `OPENAI_API_KEY` и `GOOGLE_SHEET_ID` в скрипте.
   - Добавьте email из `credentials.json` в администраторы Google Таблицы.
2. **Запустите скрипт**:
   ```
   python vk-commentator.py
   ```
3. **Работа скрипта**:
   - Запрашивает до 100 постов из ленты новостей VK.
   - Фильтрует посты по лайкам, комментариям, просмотрам, возрасту, длине текста и возможности комментирования.
   - Проверяет контент через OpenAI для отклонения неподходящего материала.
   - Генерирует остроумный комментарий (от лица "19-летней кокетливой девушки") с помощью OpenAI.
   - Публикует комментарий во ВКонтакте.
   - Сохраняет данные о комментарии (текст поста, комментарий, использование токенов, стоимость) в Google Таблицу.
   - Ожидает `COMMENT_PAUSE_MINUTES` перед следующим комментарием.
   - Если посты не проходят фильтры, увеличивает смещение или переходит в режим ожидания, если посты слишком старые.

## Вывод
- **Консоль**: Отображает информацию о постах, результаты фильтров, решения OpenAI и статус комментариев.
- **Лог-файл**: `vk_commentator.log` фиксирует все действия, ошибки и предупреждения.
- **Google Таблица**: Сохраняет данные о комментариях в лист `VK_Comments` со столбцами:
  - Дата и время
  - Текст поста
  - Текст комментария
  - Тип страницы (Группа или Личная)
  - ID владельца
  - Ссылка на пост
  - Имя комментатора
  - ID комментатора
  - Входные токены
  - Выходные токены
  - Общее количество токенов
  - Стоимость (в USD, на основе $0.15/миллион входных токенов и $0.6/миллион выходных)

## Настройка под себя
- **Стиль комментариев**: Измените промпт в функции `generate_comment` для изменения тона или персонажа комментариев.
- **Фильтры контента**: Настройте промпт в функции `check_content` для изменения критериев модерации.
- **Фильтры постов**: Измените `MIN_LIKES`, `MIN_COMMENTS`, `MIN_VIEWS`, `MAX_AGE_SECONDS`, `MIN_TEXT_LENGTH` и `MAX_TEXT_LENGTH` для таргетинга на определенные посты.
- **Тайминги**: Настройте `COMMENT_PAUSE_MINUTES` и `SLEEP_AFTER_EMPTY_MINUTES` для контроля частоты комментариев.

## Обработка ошибок
- **Ошибки VK API**:
  - Критические ошибки (например, неверный токен, бан пользователя) останавливают скрипт с сообщением.
  - Ошибки лимитов и другие ошибки вызывают повторные попытки с экспоненциальной задержкой.
- **Ошибки Google API**: Повторные попытки с задержкой; автоматическое создание листа и заголовков.
- **Ошибки OpenAI**: Ошибки логируются, пост пропускается, если генерация комментария не удалась.
- **Сетевые проблемы**: Повторные попытки с задержкой до `MAX_RETRIES`.

## Устранение неполадок
- **Ошибка VK API [5] (Неверный токен)**:
  - Проверьте `VK_API_TOKEN` и перегенерируйте его через Kate Mobile или VK Dev.
- **Ошибка VK API [18] (Пользователь заблокирован)**:
  - Аккаунт VK заблокирован; используйте другой аккаунт.
- **Ошибка Google Sheets**:
  - Убедитесь, что `credentials.json` действителен и Google Таблица доступна для email из `client_email`.
  - Проверьте `GOOGLE_SHEET_ID` и подключение к интернету.
- **Ошибка OpenAI**:
  - Убедитесь, что `OPENAI_API_KEY` верный и на счету достаточно средств.
- **Нет прокомментированных постов**:
  - Ослабьте фильтры (`MIN_LIKES`, `MIN_VIEWS` и т.д.) или увеличьте `MAX_AGE_SECONDS`.
  - Проверьте доступность постов в ленте новостей VK.
- **Проблемы с сессией**:
  - Удалите кэшированные файлы сессии, если авторизация не проходит.

## Замечания по безопасности
- **Учетные данные**: Храните `credentials.json`, `VK_API_TOKEN` и `OPENAI_API_KEY` в безопасности; не публикуйте их.
- **Лимиты**: Скрипт включает задержки (`API_DELAY`, `COMMENT_PAUSE_MINUTES`) для избежания лимитов VK и OpenAI.
- **Модерация контента**: Функция `check_content` помогает избегать комментариев к неподходящим постам, но проверяйте ответы OpenAI на точность.

## Ограничения
- Комментарии ограничены 150 символами и русским языком (согласно промпту).
- Обрабатываются только текстовые посты (без поддержки фото или видео).
- Расчет стоимости токенов основан на фиксированных тарифах ($0.15/миллион входных, $0.6/миллион выходных).
- Скрипт обрабатывает посты последовательно, что может ограничивать скорость для больших лент.

## Пример работы
1. Скрипт запускается, проверяет VK и Google Sheets API.
2. Запрашивает 100 постов из ленты новостей VK.
3. Для поста с 100 просмотрами, 5 лайками и текстом на 200 символов, опубликованного 30 минут назад:
   - Проверяет контент: OpenAI возвращает "ACCEPT".
   - Генерирует комментарий: "Ого, это так вдохновляет! Обязательно попробую!".
   - Публикует комментарий в VK.
   - Сохраняет в Google Таблицу данные с использованием токенов и стоимостью ($0.000045 за 200 входных и 50 выходных токенов).
4. Ожидает 10 минут перед обработкой следующего поста.

## Лицензия
Скрипт предоставляется "как есть" для личного использования. Убедитесь в соблюдении условий использования VK, OpenAI и Google.

## Поддержка
Для устранения проблем проверьте файл `vk_commentator.log` и вывод в консоли. Если проблемы сохраняются, проверьте учетные данные и доступ к API или обратитесь за помощью к сообществу Python.
